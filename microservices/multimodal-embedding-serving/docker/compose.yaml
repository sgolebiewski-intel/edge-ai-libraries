# Copyright (C) 2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

services:
  multimodal-embedding-serving:
    image: ${REGISTRY:-}multimodal-embedding-serving:${TAG:-latest}
    container_name: multimodal-embedding
    build:
      context: ..
      dockerfile: docker/Dockerfile
    ports:
      - "${EMBEDDING_SERVER_PORT}:8000"
    ipc: host
    environment:
      no_proxy_env: ${no_proxy_env},vdms-dataprep-ms
      http_proxy: ${http_proxy}
      https_proxy: ${https_proxy}
      TEXT_EMBEDDING_MODEL_NAME: ${QWEN_MODEL}
      IMAGE_EMBEDDING_MODEL_NAME: ${VCLIP_MODEL}
      DEFAULT_START_OFFSET_SEC: ${DEFAULT_START_OFFSET_SEC}
      DEFAULT_CLIP_DURATION: ${DEFAULT_CLIP_DURATION}
      DEFAULT_NUM_FRAMES: ${DEFAULT_NUM_FRAMES}
      EMBEDDING_USE_OV: ${EMBEDDING_USE_OV}
      USE_ONLY_TEXT_EMBEDDINGS: ${USE_ONLY_TEXT_EMBEDDINGS}
      EMBEDDING_DEVICE: ${EMBEDDING_DEVICE}
      DEBUG_MODE: ${DEBUG_MODE:-False}
    group_add:
      - ${USER_GROUP_ID:-1000}
      - ${VIDEO_GROUP_ID:-44}
      - ${RENDER_GROUP_ID:-1002}
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 40
      start_period: 5s
    devices:
      - /dev/dri:/dev/dri
    networks:
      - my_network
    volumes:
      - ov-models:/home/appuser/.cache/huggingface
      - data-prep:/tmp/dataprep
      - ov-models:/app/ov-models
volumes:
  data-prep:
    external: true
  ov-models:
    external: true
networks:
  my_network:
    driver: bridge
